generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int           @id @default(autoincrement())
  username    String        @unique
  email       String        @unique
  password    String
  role        Role
  isActive    Boolean       @default(true)
  twoFAEnabled Boolean  @default(false)
  twoFASecret  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  pengeluaran Pengeluaran[]
}

model Barang {
  id                    Int             @id @default(autoincrement())
  namaBarang            String
  hargaBeli             BigInt
  hargaJual             BigInt
  stok                  BigInt          @default(0)
  jenisKemasan          String
  jumlahPerKemasan      BigInt
  supplier              Supplier        @relation(fields: [supplierId], references: [id])
  supplierId            Int
  berat                 BigInt          @default(0)
  limitStok             BigInt          @default(0)
  limitPenjualan        BigInt          @default(0)
  pembelianItems        PembelianItem[]
  penjualanItems        PenjualanItem[]
  manifestBarang        ManifestBarang[]
  pengembalianBarang    PengembalianBarang[]
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  isActive              Boolean         @default(true)
}

model Supplier {
  id           Int               @id @default(autoincrement())
  namaSupplier String
  alamat       String
  noHp         String
  limitHutang  BigInt
  hutang       BigInt            @default(0)
  barang       Barang[]
  pembelian    PembelianHeader[]
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
}

model Karyawan {
  id                        Int               @id @default(autoincrement())
  nama                      String
  nik                       String            @unique
  noHp                      String?
  alamat                    String?
  jenis                     JenisKaryawan
  gajiPokok                 Int
  tunjanganMakan            Int
  totalPinjaman             Int               @default(0)
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  penjualanHeaders          PenjualanHeader[]
  perjalananSales           PerjalananSales[]
  pinjamanKaryawan          PinjamanKaryawan[]
  pembayaranHutangKaryawan  PembayaranHutangKaryawan[]
  isActive                  Boolean           @default(true)
}

model PinjamanKaryawan {
  id              Int        @id @default(autoincrement())
  karyawan        Karyawan   @relation(fields: [karyawanId], references: [id])
  karyawanId      Int
  jumlahPinjaman  Int
  userId          Int?
  keterangan      String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model PembayaranHutangKaryawan {
  id              Int        @id @default(autoincrement())
  karyawan        Karyawan   @relation(fields: [karyawanId], references: [id])
  karyawanId      Int
  jumlahbayar     Int
  userId          Int?
  tanggalbayar    DateTime   @default(now())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Customer {
  id            Int               @id @default(autoincrement())
  nik           String            @unique
  nama          String
  alamat        String
  namaToko      String
  noHp          String
  limit_piutang BigInt            @default(0)
  piutang       BigInt            @default(0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  penjualan     PenjualanHeader[]
  isActive      Boolean           @default(true)
}

model PembelianHeader {
  id                Int              @id @default(autoincrement())
  kodePembelian     String           @unique
  supplier          Supplier         @relation(fields: [supplierId], references: [id])
  supplierId        Int
  subtotal          BigInt           @default(0)
  diskonNota        BigInt           @default(0)
  totalHarga        BigInt           @default(0)
  jumlahDibayar     BigInt           @default(0)
  kembalian         BigInt           @default(0)
  keterangan        String?
  statusPembayaran  StatusPembayaran @default(HUTANG)
  statusTransaksi   StatusTransaksi  @default(KERANJANG)
  items             PembelianItem[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  tanggalJatuhTempo DateTime         @default(now())
}

model PembelianItem {
  id            Int             @id @default(autoincrement())
  pembelian     PembelianHeader @relation(fields: [pembelianId], references: [id], onDelete: Cascade)
  pembelianId   Int
  barang        Barang          @relation(fields: [barangId], references: [id])
  barangId      Int
  totalItem     BigInt          @default(0)
  hargaPokok    BigInt
  diskonPerItem BigInt          @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model PenjualanHeader {
  id                    Int              @id @default(autoincrement())
  kodePenjualan         String           @unique
  customer              Customer?        @relation(fields: [customerId], references: [id])
  customerId            Int?
  namaCustomer          String?
  karyawan              Karyawan?        @relation(fields: [karyawanId], references: [id])
  karyawanId            Int?
  subtotal              BigInt           @default(0)
  diskonNota            BigInt           @default(0)
  totalHarga            BigInt           @default(0)
  jumlahDibayar         BigInt           @default(0)
  kembalian             BigInt           @default(0)
  keterangan            String?
  beratTotal            BigInt           @default(0)
  metodePembayaran      MetodePembayaran @default(CASH)
  statusPembayaran      StatusPembayaran @default(HUTANG)
  statusTransaksi       StatusTransaksi  @default(KERANJANG)
  tanggalTransaksi      DateTime         @default(now())
  tanggalJatuhTempo     DateTime?
  isDeleted             Boolean         @default(false)
  userId                Int?
  items                 PenjualanItem[]
  perjalananSales       PerjalananSales? @relation(fields: [perjalananSalesId], references: [id])
  pembayaran            PembayaranPenjualan[]
  perjalananSalesId     Int?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
}

model PembayaranPenjualan {
  id                    Int              @id @default(autoincrement())
  kodePembayaran        String           @unique
  penjualanId           Int
  penjualan             PenjualanHeader  @relation(fields: [penjualanId], references: [id], onDelete: Cascade)
  tanggalBayar          DateTime         @default(now())
  nominal               BigInt
  totalCash             BigInt           @default(0)
  totalTransfer         BigInt           @default(0)
  metode                MetodePembayaran @default(CASH)
  jenisPembayaran       String           @default("PENJUALAN")
  catatan               String?
  userId                Int?
  createdAt             DateTime         @default(now())
  @@index([penjualanId])
  @@index([tanggalBayar])
}


model PenjualanItem {
  id            Int             @id @default(autoincrement())
  penjualanId   Int
  barangId      Int
  totalItem     BigInt          @default(0)
  hargaJual     BigInt
  berat         BigInt          @default(0)
  hargaBeli     BigInt          @default(0)
  diskonPerItem BigInt          @default(0)
  laba          BigInt          @default(0)
  penjualan     PenjualanHeader @relation(fields: [penjualanId], references: [id], onDelete: Cascade)
  barang        Barang          @relation(fields: [barangId], references: [id])
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  @@index([penjualanId])
  @@index([barangId])
}

model Pengeluaran {
  id                Int      @id @default(autoincrement())
  namaPengeluaran   String
  jumlah            BigInt
  jenisPengeluaran  JenisPengeluaran  @default(HARIAN)
  keterangan        String?
  tanggalInput      DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id])
  userId            Int
}

model PerjalananSales {
  id                    Int                     @id @default(autoincrement())
  kodePerjalanan        String                  @unique
  karyawan              Karyawan                @relation(fields: [karyawanId], references: [id])
  karyawanId            Int
  kotaTujuan            String
  tanggalBerangkat      DateTime
  tanggalKembali        DateTime?
  totalBerat            BigInt                  @default(0)
  statusPerjalanan      StatusPerjalanan        @default(DI_PERJALANAN)
  keterangan            String?
  isDeleted             Boolean                 @default(false)
  manifestBarang        ManifestBarang[]
  penjualanHeaders      PenjualanHeader[]
  pengembalianBarang    PengembalianBarang[]
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  createdBy             Int
  @@index([karyawanId])
  @@index([statusPerjalanan])
}

model ManifestBarang {
  id                    Int                     @id @default(autoincrement())
  perjalanan            PerjalananSales         @relation(fields: [perjalananId], references: [id], onDelete: Cascade)
  perjalananId          Int
  barang                Barang                  @relation(fields: [barangId], references: [id])
  barangId              Int
  jumlahDibawa          BigInt                  
  totalItem             BigInt                  // Sisa yang belum direkonsiliasi (dikurangi saat transaksi/pengembalian)
  jumlahTerjual         BigInt                  @default(0)
  jumlahKembali         BigInt                  @default(0)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  @@index([perjalananId])
  @@index([barangId])
  @@unique([perjalananId, barangId])
}

model PengembalianBarang {
  id                    Int                     @id @default(autoincrement())
  perjalanan            PerjalananSales?         @relation(fields: [perjalananId], references: [id], onDelete: Cascade)
  perjalananId          Int?
  barang                Barang                  @relation(fields: [barangId], references: [id])
  barangId              Int
  jumlahDus             BigInt
  jumlahPcs             BigInt
  userId                Int?
  kondisiBarang         KondisiBarang           @default(BAIK)
  keterangan            String?
  tanggalPengembalian   DateTime                @default(now())
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  @@index([perjalananId])
  @@index([barangId])
}

enum MetodePembayaran {
  CASH
  TRANSFER
  CASH_TRANSFER
}

enum StatusPembayaran {
  LUNAS
  HUTANG
}

enum StatusTransaksi {
  KERANJANG
  SELESAI
  DIBATALKAN
}

enum Role {
  ADMIN
  KASIR
  KEPALA_GUDANG
}

enum JenisKaryawan {
  KASIR
  SALES
  KARYAWAN
  KEPALA_GUDANG
}

enum StatusPerjalanan {     
  DI_PERJALANAN       
  KEMBALI             
  SELESAI            
  DIBATALKAN
}

enum KondisiBarang {
  BAIK
  RUSAK
  KADALUARSA
}

enum JenisPengeluaran {
  HARIAN
  MINGGUAN
  BULANAN
  TAHUNAN
}
